<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ·ï¸ ë‚˜ì˜ íš¨ë„ ì¸ì¦ì„œ ë§Œë“¤ê¸° (ìµœì¢… ì™„ì„±ë³¸)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .feedback-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-weight: bold; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-red-50">

    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg text-center"><h3 class="text-xl font-bold mb-4">ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ ì°ê¸°</h3><video id="camera-feed" class="w-full h-auto bg-gray-900 rounded" autoplay playsinline></video><canvas id="camera-canvas" class="hidden"></canvas><p id="camera-error" class="hidden text-red-500 my-2">ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p><div class="mt-4 flex justify-center gap-4"><button id="shutter-btn" class="px-5 py-2 bg-rose-500 text-white font-bold rounded-full shadow-lg text-2xl">ğŸ“¸</button><button id="use-picture-btn" class="hidden px-5 py-2 bg-green-500 text-white font-bold rounded-lg">ì´ ì‚¬ì§„ ì‚¬ìš©</button><button id="close-camera-btn" class="px-5 py-2 bg-gray-300 rounded-lg">ë‹«ê¸°</button></div></div>
    </div>

    <div class="container mx-auto max-w-6xl p-4 sm:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-rose-800">ğŸ·ï¸ ë‚˜ì˜ íš¨ë„ ì¸ì¦ì„œ ë§Œë“¤ê¸°</h1>
            <p class="text-stone-600 mt-2">ë‚´ê°€ ì‹¤ì²œí•œ íš¨ë„ë¥¼ ë©‹ì§„ ì¸ì¦ì„œë¡œ ë§Œë“¤ê³ , ê·¸ ê²½í—˜ì„ ê¸°ë¡í•´ë´…ì‹œë‹¤.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <form id="activity-form" class="bg-white rounded-2xl shadow-lg p-6 space-y-8">
                <section><h2 class="text-xl font-bold text-rose-600 mb-3">í•™ìƒ ì •ë³´</h2><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div class="sm:col-span-1"><label for="school-input" class="text-sm font-semibold">í•™êµ</label><input type="text" id="school-input" class="w-full p-2 border rounded-md mt-1" placeholder="ì˜ˆ: í–‰ë³µì´ˆ"></div><div class="sm:col-span-1"><label for="class-grade-input" class="text-sm font-semibold">í•™ë°˜</label><input type="text" id="class-grade-input" class="w-full p-2 border rounded-md mt-1" placeholder="ì˜ˆ: 6í•™ë…„ 1ë°˜"></div><div class="sm:col-span-1"><label for="name-input" class="text-sm font-semibold">ì´ë¦„</label><input type="text" id="name-input" class="w-full p-2 border rounded-md mt-1" placeholder="ì˜ˆ: í™ê¸¸ë™"></div></div></section>
                <section><h2 class="text-xl font-bold text-rose-600 mb-3">ğŸŸ¡ ìƒê° ë‚˜ëˆ„ê¸°</h2><p class="font-semibold text-stone-700 mb-2">Q. 'íš¨ë„'í•˜ë©´ ì–´ë–¤ ëª¨ìŠµì´ ë– ì˜¤ë¥´ë‚˜ìš”? (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</p><div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm"><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="ì§‘ì•ˆì¼ ë•ê¸°" class="mr-2">ì§‘ì•ˆì¼ ë•ê¸°</label><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="ë§ ì˜ˆì˜ê²Œ í•˜ê¸°" class="mr-2">ë§ ì˜ˆì˜ê²Œ í•˜ê¸°</label><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="í•¨ê»˜ ì‹œê°„ ë³´ë‚´ê¸°" class="mr-2">í•¨ê»˜ ì‹œê°„ ë³´ë‚´ê¸°</label><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="í¸ì§€ ì“°ê¸°" class="mr-2">í¸ì§€ ì“°ê¸°</label><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="ì•ˆë§ˆ í•´ë“œë¦¬ê¸°" class="mr-2">ì•ˆë§ˆ í•´ë“œë¦¬ê¸°</label><label class="p-2 border rounded-md has-[:checked]:bg-rose-100"><input type="checkbox" name="thought" value="ë‚´ í•  ì¼ ìŠ¤ìŠ¤ë¡œ" class="mr-2">ë‚´ í•  ì¼ ìŠ¤ìŠ¤ë¡œ</label></div></section>
                <section><h2 class="text-xl font-bold text-rose-600 mb-3">ğŸ”µ ë‚´ê°€ ì‹¤ì²œí•œ íš¨ë„ ì¸ì¦í•˜ê¸°</h2><label class="font-semibold text-stone-700 block mb-2">"ìµœê·¼ì— ë‚´ê°€ ì‹¤ì²œí–ˆë˜ íš¨ë„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ 'ì‹¤ì²œ ì™„ë£Œ ì¸ì¦ì„œ'ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!"</label><div id="coupon-items-container"><div class="coupon-item mb-3 p-3 border border-dashed border-rose-200 rounded-lg"><div class="flex gap-2 items-center mb-2"><input type="text" class="coupon-input flex-1 p-2 border rounded-md" placeholder="ì˜ˆ: ì„¤ê±°ì§€ ë„ì™€ë“œë¦¬ê¸° (ì‹¤ì²œ ì™„ë£Œ!)"><button type="button" class="remove-coupon-btn hidden px-3 py-2 bg-red-500 text-white rounded-md text-sm">ì‚­ì œ</button></div></div></div><button type="button" id="add-coupon-btn" class="w-full py-2 bg-blue-500 text-white font-bold rounded-lg mb-4">â• íš¨ë„ ì‹¤ì²œ ë‚´ìš© ì¶”ê°€í•˜ê¸°</button><div class="bg-blue-50 p-3 rounded-lg mb-4"><p class="text-sm text-blue-700">ğŸ’¡ <strong>ì‚¬ì§„ ì•ˆë‚´:</strong> ì—¬ëŸ¬ ê°œì˜ íš¨ë„ ì‹¤ì²œ ë‚´ìš© ì¤‘ ê°€ì¥ ëŒ€í‘œì ì¸ 1ê°œì˜ ì‚¬ì§„ë§Œ ì˜¬ë ¤ì£¼ì„¸ìš”. ì¸ì¦ì„œì— í•¨ê»˜ í‘œì‹œë©ë‹ˆë‹¤.</p></div><div class="mt-4"><p class="font-semibold text-stone-700 mb-2">ëŒ€í‘œ ì¸ì¦ ì‚¬ì§„ì„ ë„£ì–´ë³´ì„¸ìš”.</p><div class="flex gap-4"><button type="button" id="open-camera-btn" class="flex-1 py-2 bg-rose-500 text-white font-bold rounded-lg">ğŸ“¸ ì¹´ë©”ë¼ë¡œ ì°ê¸°</button><label class="flex-1 py-2 bg-amber-500 text-white font-bold rounded-lg text-center cursor-pointer">ğŸ“‚ íŒŒì¼ì—ì„œ ì„ íƒ<input type="file" id="image-upload" class="hidden" accept="image/*"></label></div></div></section>
                <section><h2 class="text-xl font-bold text-rose-600 mb-3">ğŸ”´ 'íš¨ë„ ì¼ê¸°' ì“°ê¸°</h2><p class="font-semibold text-stone-700 mb-2">"íš¨ë„ë¥¼ ì‹¤ì²œí•œ ë’¤, ì–´ë–¤ ëŠë‚Œì´ ë“¤ì—ˆëŠ”ì§€ ê¸°ë¡í•´ ë³´ì„¸ìš”."</p><input type="date" id="diary-date" class="w-full p-2 border rounded-md mb-2"><textarea id="diary-text" rows="3" class="w-full p-2 border rounded-md" placeholder="ë‚˜ì˜ ìƒê°ì´ë‚˜ ê°€ì¡±ì˜ ë°˜ì‘ì„ ì ì–´ë´ìš”."></textarea><fieldset class="mt-2"><legend class="font-semibold text-sm mb-1">ì˜¤ëŠ˜ ë‚˜ì˜ íš¨ë„ ì ìˆ˜ëŠ”? â­</legend><div class="grid grid-cols-1 gap-2 text-sm"><label class="p-2 border rounded-md has-[:checked]:bg-green-100 cursor-pointer"><input type="radio" name="king" value="ğŸŒŸğŸŒŸğŸŒŸ íš¨ë„ ëŒ€ì™•! (ì™„ë²½í•´ìš”!)" class="mr-2">ğŸŒŸğŸŒŸğŸŒŸ íš¨ë„ ëŒ€ì™•! (ì™„ë²½í•´ìš”!)</label><label class="p-2 border rounded-md has-[:checked]:bg-yellow-100 cursor-pointer"><input type="radio" name="king" value="â­â­ íš¨ë„ ì™•ì/ê³µì£¼ (ì˜í–ˆì–´ìš”!)" class="mr-2">â­â­ íš¨ë„ ì™•ì/ê³µì£¼ (ì˜í–ˆì–´ìš”!)</label><label class="p-2 border rounded-md has-[:checked]:bg-blue-100 cursor-pointer"><input type="radio" name="king" value="â­ íš¨ë„ ìƒˆì‹¹ (ë” ë…¸ë ¥í•´ë´ìš”!)" class="mr-2">â­ íš¨ë„ ìƒˆì‹¹ (ë” ë…¸ë ¥í•´ë´ìš”!)</label></div></fieldset></section>
                <section><h2 class="text-xl font-bold text-rose-600 mb-3">ğŸŸ¢ ë‹¤ì§í•˜ê¸°</h2><label for="pledge-input" class="font-semibold text-stone-700 mb-2">ì˜¤ëŠ˜ ë‚˜ì˜ ë‹¤ì§ì„ ì§ì ‘ ì ì–´ë³´ì„¸ìš”.</label><textarea id="pledge-input" rows="2" class="w-full p-2 border rounded-md" placeholder="ì˜ˆ: ì•ìœ¼ë¡œë„ ë¶€ëª¨ë‹˜ ë§ì”€ì„ ì˜ ë“£ê² ìŠµë‹ˆë‹¤."></textarea></section>
            </form>
            
            <div id="capture-area" class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
                <div id="student-info-preview" class="text-right text-sm text-stone-500">ì •ë³´ ì—†ìŒ</div>
                <div class="bg-gradient-to-br from-rose-100 to-amber-100 p-4 rounded-lg border-2 border-dashed border-rose-300"><div class="flex gap-4 items-start"><div id="coupon-image-preview" class="w-24 h-24 sm:w-32 sm:h-32 rounded-full bg-white flex-shrink-0 flex items-center justify-center text-gray-400 text-xs overflow-hidden">ì¸ì¦ìƒ·</div><div class="flex flex-col justify-center flex-1"><h3 class="text-lg sm:text-xl font-bold text-rose-700">ğŸ† íš¨ë„ ì‹¤ì²œ ì¸ì¦ì„œ ğŸ†</h3><div id="coupon-titles-preview" class="mt-2 text-stone-600 space-y-1"><p>ì¸ì¦í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p></div><p class="text-xs text-stone-500 mt-2">ì¸ì¦ì¼: <span id="issue-date"></span></p></div></div></div>
                <div class="bg-stone-50 p-4 rounded-lg"><h3 class="text-lg font-bold text-stone-700">ğŸ’– íš¨ë„ ì¼ê¸°</h3><p class="text-sm text-stone-500 mb-2" id="diary-date-preview">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p><p class="text-stone-600 min-h-[4rem]" id="diary-text-preview">...</p><p class="text-right mt-2 font-bold" id="king-preview">íš¨ë„ ì ìˆ˜: ?</p></div>
                <div class="bg-green-50 p-4 rounded-lg text-center"><h3 class="text-lg font-bold text-green-800">âœ¨ ì˜¤ëŠ˜ì˜ ë‹¤ì§ âœ¨</h3><p id="pledge-preview" class="text-green-700 mt-2 min-h-[1.5rem]">ë‹¤ì§ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p></div>
            </div>
        </main>
        
        <footer class="mt-8 py-6 flex flex-wrap justify-center gap-4">
            <button id="download-btn" class="px-8 py-3 bg-rose-600 text-white font-bold rounded-lg shadow-lg hover:bg-rose-700">ğŸ“„ ì¸ì¦ì„œ+ì¼ê¸° PDFë¡œ ì €ì¥</button>
            <button id="reset-btn" class="px-8 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-lg hover:bg-gray-600">ğŸ”„ ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°</button>
        </footer>
    </div>

    <script>
    // ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
        
        class ImageProcessor {
            static resizeImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = "high";
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL("image/jpeg", quality));
                    };
                    img.onerror = reject;
                    img.src = URL.createObjectURL(file);
                });
            }
            
            static optimizeCameraImage(canvas, quality = 0.8) {
                return canvas.toDataURL("image/jpeg", quality);
            }
            
            static showProcessingMessage() {
                const div = document.createElement("div");
                div.id = "image-processing";
                div.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
                div.innerHTML = '<div class="bg-white rounded-lg p-6 text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-500 mx-auto mb-4"></div><p class="text-gray-700">ì‚¬ì§„ì„ ì²˜ë¦¬í•˜ê³  ìˆì–´ìš”...</p></div>';
                document.body.appendChild(div);
            }
            
            static hideProcessingMessage() {
                const processingDiv = document.getElementById("image-processing");
                if (processingDiv) {
                    processingDiv.remove();
                }
            }
        }

        class FilialPietyCouponApp {
            constructor() {
                this.stream = null;
                this.elements = this.initializeElements();
                this.bindEvents();
                this.loadData();
                this.updateRemoveButtons(); // ì´ˆê¸° ì‚­ì œ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
                // 10ì´ˆë§ˆë‹¤ ìë™ ì €ì¥
                setInterval(() => this.saveData(), 10000);
            }

            initializeElements() {
                const elements = {};
                const elementIds = [
                    'activity-form', 'school-input', 'class-grade-input', 'name-input', 
                    'image-upload', 'diary-date', 'diary-text', 'pledge-input', 'student-info-preview', 
                    'coupon-image-preview', 'coupon-titles-preview', 'issue-date', 'diary-date-preview', 
                    'diary-text-preview', 'king-preview', 'pledge-preview', 'download-btn', 'reset-btn', 
                    'camera-modal', 'open-camera-btn', 'close-camera-btn', 'shutter-btn', 
                    'use-picture-btn', 'camera-feed', 'camera-canvas', 'camera-error',
                    'coupon-items-container', 'add-coupon-btn'
                ];
                
                elementIds.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (match, letter) => letter.toUpperCase());
                    elements[camelCaseId] = document.getElementById(id);
                });
                
                elements.kingRadios = document.querySelectorAll('input[name="king"]');
                elements.thoughtCheckboxes = document.querySelectorAll('input[name="thought"]');
                return elements;
            }

            bindEvents() {
                const el = this.elements;
                
                // Input events
                el.schoolInput.addEventListener('input', () => this.updateAllPreviews());
                el.classGradeInput.addEventListener('input', () => this.updateAllPreviews());
                el.nameInput.addEventListener('input', () => this.updateAllPreviews());
                el.diaryDate.addEventListener('input', () => this.updateAllPreviews());
                el.diaryText.addEventListener('input', () => this.updateAllPreviews());
                el.pledgeInput.addEventListener('input', () => this.updateAllPreviews());
                el.kingRadios.forEach(radio => radio.addEventListener('change', () => this.updateAllPreviews()));
                el.imageUpload.addEventListener('change', (e) => this.handleFileUpload(e));
                
                // ë™ì  ì¿ í° ì…ë ¥ í•„ë“œì— ëŒ€í•œ ì´ë²¤íŠ¸ ìœ„ì„
                el.couponItemsContainer.addEventListener('input', (e) => {
                    if (e.target.classList.contains('coupon-input')) {
                        this.updateAllPreviews();
                    }
                });
                
                el.couponItemsContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-coupon-btn')) {
                        this.removeCouponItem(e.target.closest('.coupon-item'));
                    }
                });
                
                // Button events
                el.addCouponBtn.addEventListener('click', () => this.addCouponItem());
                el.openCameraBtn.addEventListener('click', () => this.openCamera());
                el.closeCameraBtn.addEventListener('click', () => this.closeCamera());
                el.shutterBtn.addEventListener('click', () => this.takePicture());
                el.usePictureBtn.addEventListener('click', () => this.useCapturedPicture());
                el.downloadBtn.addEventListener('click', () => this.downloadPDF());
                el.resetBtn.addEventListener('click', () => this.resetForm());
            }

            addCouponItem() {
                const container = this.elements.couponItemsContainer;
                const itemCount = container.children.length;
                
                if (itemCount >= 5) {
                    this.showFeedback('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”! ğŸ“', false);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'coupon-item mb-3 p-3 border border-dashed border-rose-200 rounded-lg';
                newItem.innerHTML = `
                    <div class="flex gap-2 items-center mb-2">
                        <input type="text" class="coupon-input flex-1 p-2 border rounded-md" placeholder="ì˜ˆ: ë¶€ëª¨ë‹˜ê»˜ ì•ˆë§ˆ í•´ë“œë¦¬ê¸° (ì‹¤ì²œ ì™„ë£Œ!)">
                        <button type="button" class="remove-coupon-btn px-3 py-2 bg-red-500 text-white rounded-md text-sm">ì‚­ì œ</button>
                    </div>
                `;
                
                container.appendChild(newItem);
                this.updateRemoveButtons();
                this.updateAllPreviews();
                
                // ìƒˆë¡œ ì¶”ê°€ëœ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                newItem.querySelector('.coupon-input').focus();
                this.showFeedback('ìƒˆë¡œìš´ íš¨ë„ ì‹¤ì²œ ë‚´ìš©ì´ ì¶”ê°€ë˜ì—ˆì–´ìš”! âœ¨');
            }

            removeCouponItem(item) {
                const container = this.elements.couponItemsContainer;
                if (container.children.length <= 1) {
                    this.showFeedback('ìµœì†Œ 1ê°œëŠ” ë‚¨ê²¨ë‘ì–´ì•¼ í•´ìš”! ğŸ“', false);
                    return;
                }
                
                item.remove();
                this.updateRemoveButtons();
                this.updateAllPreviews();
                this.showFeedback('í•­ëª©ì´ ì‚­ì œë˜ì—ˆì–´ìš”.');
            }

            updateRemoveButtons() {
                const container = this.elements.couponItemsContainer;
                const items = container.children;
                
                for (let i = 0; i < items.length; i++) {
                    const removeBtn = items[i].querySelector('.remove-coupon-btn');
                    if (items.length === 1) {
                        removeBtn.classList.add('hidden');
                    } else {
                        removeBtn.classList.remove('hidden');
                    }
                }
            }

            getCouponTitles() {
                const inputs = this.elements.couponItemsContainer.querySelectorAll('.coupon-input');
                return Array.from(inputs).map(input => input.value.trim()).filter(value => value);
            }

            updateAllPreviews() {
                // Student Info
                const school = this.elements.schoolInput.value || '';
                const classGrade = this.elements.classGradeInput.value || '';
                const name = this.elements.nameInput.value || 'ì •ë³´ ì—†ìŒ';
                this.elements.studentInfoPreview.textContent = `${school} ${classGrade} ${name}`.trim() || 'ì •ë³´ ì—†ìŒ';

                // Coupon Titles
                const couponTitles = this.getCouponTitles();
                if (couponTitles.length === 0) {
                    this.elements.couponTitlesPreview.innerHTML = '<p>ì¸ì¦í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.</p>';
                } else {
                    this.elements.couponTitlesPreview.innerHTML = couponTitles
                        .map((title, index) => `<p>â€¢ ${title}</p>`)
                        .join('');
                }
                this.elements.issueDate.textContent = new Date().toLocaleDateString('ko-KR');

                // Diary
                this.elements.diaryDatePreview.textContent = this.elements.diaryDate.value ? 
                    new Date(this.elements.diaryDate.value).toLocaleDateString('ko-KR') : 'ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.';
                this.elements.diaryTextPreview.textContent = this.elements.diaryText.value || '...';
                const selectedKing = document.querySelector('input[name="king"]:checked');
                this.elements.kingPreview.textContent = `íš¨ë„ ì ìˆ˜: ${selectedKing ? selectedKing.value : '?'}`;
                
                // Pledge
                this.elements.pledgePreview.textContent = this.elements.pledgeInput.value || 'ë‹¤ì§ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }

            setCouponImage(src) {
                this.elements.couponImagePreview.innerHTML = `<img src="${src}" class="w-full h-full object-cover rounded-full">`;
            }

            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                ImageProcessor.showProcessingMessage();
                try {
                    const optimizedImage = await ImageProcessor.resizeImage(file);
                    this.setCouponImage(optimizedImage);
                    this.showFeedback('ì‚¬ì§„ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆì–´ìš”! ğŸ“¸');
                } catch (error) {
                    console.error('Image processing error:', error);
                    this.showFeedback('ì‚¬ì§„ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.', false);
                } finally {
                    ImageProcessor.hideProcessingMessage();
                }
            }

            async openCamera() {
                this.elements.cameraError.classList.add('hidden');
                try {
                    if (this.stream) { 
                        this.stream.getTracks().forEach(track => track.stop()); 
                    }
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user' } 
                    });
                    this.elements.cameraModal.classList.remove('hidden');
                    this.elements.cameraFeed.srcObject = this.stream;
                    this.elements.cameraFeed.style.display = 'block';
                    this.elements.cameraCanvas.style.display = 'none';
                    this.elements.usePictureBtn.classList.add('hidden');
                } catch (err) {
                    console.error("Camera error:", err);
                    this.elements.cameraError.classList.remove('hidden');
                }
            }
            
            takePicture() {
                const canvas = this.elements.cameraCanvas;
                const video = this.elements.cameraFeed;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                video.style.display = 'none';
                canvas.style.display = 'block';
                this.elements.usePictureBtn.classList.remove('hidden');
            }

            useCapturedPicture() {
                const optimizedImage = ImageProcessor.optimizeCameraImage(this.elements.cameraCanvas);
                this.setCouponImage(optimizedImage);
                this.closeCamera();
                this.showFeedback('ë©‹ì§„ ì‚¬ì§„ì´ ì°í˜”ì–´ìš”! ğŸ“¸');
            }
            
            closeCamera() {
                if (this.stream) { 
                    this.stream.getTracks().forEach(track => track.stop()); 
                }
                this.elements.cameraModal.classList.add('hidden');
            }

            waitForImages() {
                const images = document.querySelectorAll('#capture-area img');
                const promises = Array.from(images).map(img => {
                    if (img.complete) return Promise.resolve();
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve; // Continue even if an image fails to load
                    });
                });
                return Promise.all(promises);
            }

            async downloadPDF() {
                this.showFeedback('PDF ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.', true);
                try {
                    // ì´ë¯¸ì§€ê°€ ëª¨ë‘ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    await this.waitForImages();
                    
                    // HTML2Canvasë¡œ ìº¡ì²˜
                    const canvas = await html2canvas(document.getElementById('capture-area'), { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: '#ffffff',
                        logging: false
                    });
                    
                    // PDF ìƒì„±
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save('ë‚˜ì˜_íš¨ë„ì¸ì¦ì„œ.pdf');
                    
                    this.showFeedback('âœ… PDFê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', true);
                } catch (error) {
                    console.error('PDF creation error:', error);
                    this.showFeedback('âš ï¸ PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
                }
            }

            resetForm() {
                if (confirm("ì •ë§ë¡œ ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í• ê¹Œìš”?")) {
                    this.elements.activityForm.reset();
                    this.elements.couponImagePreview.innerHTML = 'ì¸ì¦ìƒ·';
                    
                    // ì¿ í° í•­ëª©ì„ 1ê°œë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì œê±°
                    const container = this.elements.couponItemsContainer;
                    while (container.children.length > 1) {
                        container.removeChild(container.lastChild);
                    }
                    // ì²« ë²ˆì§¸ í•­ëª©ì˜ ê°’ë„ ì´ˆê¸°í™”
                    const firstInput = container.querySelector('.coupon-input');
                    if (firstInput) firstInput.value = '';
                    
                    this.updateRemoveButtons();
                    this.updateAllPreviews();
                    localStorage.removeItem('filialPietyAppData');
                    this.showFeedback('ëª¨ë“  ë‚´ìš©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }

            saveData() {
                try {
                    const thoughts = Array.from(this.elements.thoughtCheckboxes)
                                        .filter(cb => cb.checked)
                                        .map(cb => cb.value);
                    const kingValue = document.querySelector('input[name="king"]:checked')?.value || '';
                    const couponTitles = this.getCouponTitles();

                    const data = {
                        school: this.elements.schoolInput.value,
                        classGrade: this.elements.classGradeInput.value,
                        name: this.elements.nameInput.value,
                        couponTitles: couponTitles,
                        diaryDate: this.elements.diaryDate.value,
                        diaryText: this.elements.diaryText.value,
                        pledge: this.elements.pledgeInput.value,
                        thoughts: thoughts,
                        king: kingValue,
                        // ì´ë¯¸ì§€ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ (ë³´ì•ˆ ë° ìš©ëŸ‰ ë¬¸ì œ)
                    };
                    localStorage.setItem('filialPietyAppData', JSON.stringify(data));
                } catch (error) {
                    console.warn('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }

            loadData() {
                try {
                    const data = JSON.parse(localStorage.getItem('filialPietyAppData') || '{}');
                    if (Object.keys(data).length === 0) {
                        this.updateAllPreviews();
                        return;
                    }
                    
                    this.elements.schoolInput.value = data.school || '';
                    this.elements.classGradeInput.value = data.classGrade || '';
                    this.elements.nameInput.value = data.name || '';
                    this.elements.diaryDate.value = data.diaryDate || '';
                    this.elements.diaryText.value = data.diaryText || '';
                    this.elements.pledgeInput.value = data.pledge || '';
                    
                    // ì¿ í° ì œëª©ë“¤ ë³µì›
                    if (data.couponTitles && Array.isArray(data.couponTitles)) {
                        const container = this.elements.couponItemsContainer;
                        // ê¸°ì¡´ í•­ëª©ë“¤ ëª¨ë‘ ì œê±°
                        container.innerHTML = '';
                        
                        // ì €ì¥ëœ í•­ëª©ë“¤ ë³µì› (ìµœì†Œ 1ê°œëŠ” ë³´ì¥)
                        const titlesToRestore = data.couponTitles.length > 0 ? data.couponTitles : [''];
                        titlesToRestore.forEach((title, index) => {
                            const newItem = document.createElement('div');
                            newItem.className = 'coupon-item mb-3 p-3 border border-dashed border-rose-200 rounded-lg';
                            newItem.innerHTML = `
                                <div class="flex gap-2 items-center mb-2">
                                    <input type="text" class="coupon-input flex-1 p-2 border rounded-md" value="${title}" placeholder="ì˜ˆ: ì„¤ê±°ì§€ ë„ì™€ë“œë¦¬ê¸° (ì‹¤ì²œ ì™„ë£Œ!)">
                                    <button type="button" class="remove-coupon-btn px-3 py-2 bg-red-500 text-white rounded-md text-sm">ì‚­ì œ</button>
                                </div>
                            `;
                            container.appendChild(newItem);
                        });
                        this.updateRemoveButtons();
                    } else if (data.couponTitle) {
                        // ê¸°ì¡´ ë‹¨ì¼ ì¿ í° ì œëª© í˜¸í™˜ì„± ìœ ì§€
                        const firstInput = this.elements.couponItemsContainer.querySelector('.coupon-input');
                        if (firstInput) firstInput.value = data.couponTitle;
                    }
                    
                    if (data.king) {
                        const kingRadio = document.querySelector(`input[name="king"][value="${data.king}"]`);
                        if (kingRadio) kingRadio.checked = true;
                    }

                    this.elements.thoughtCheckboxes.forEach(cb => {
                        if (data.thoughts?.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    
                    this.updateAllPreviews();
                    this.showFeedback('ì´ì „ ì‘ì—… ë‚´ìš©ì„ ë³µì›í–ˆìŠµë‹ˆë‹¤.');
                } catch (error) {
                    console.warn('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.updateAllPreviews();
                }
            }

            showFeedback(message, isSuccess = true) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = 'feedback-toast';
                toast.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545';
                document.body.appendChild(toast);
                
                setTimeout(() => { toast.style.opacity = '1'; }, 10);
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => { 
                        if (toast.parentNode) {
                            toast.remove(); 
                        }
                    }, 500);
                }, 3000);
            }
        }

        // ì•± ì´ˆê¸°í™”
        try {
            new FilialPietyCouponApp();
        } catch (error) {
            console.error('ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            alert('ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }
    });
    </script>
</body>
</html>